# LibReport Database Layout

This project uses MongoDB. Collections are created automatically from the Mongoose schemas in `Backend/server.js`. Connect your cloud database or MongoDB Compass instance with the same collection names and fields listed below to align with the running application.

## Collections

### `users`
Stores student accounts that can access the student portal.

| Field | Type | Notes |
| --- | --- | --- |
| `_id` | ObjectId | Primary key generated by MongoDB. |
| `studentId` | String | Required. Unique. Hyphenated format `00-0000-00000` (allows 5 or 6 digits at the end) is enforced (`STUDENT_ID_REGEX`). |
| `email` | String | Required. Unique, lowercase. |
| `name` | String | Optional display name kept for legacy data. |
| `fullName` | String | Required. Trimmed text. |
| `barcode` | String | Optional. Unique + sparse. Not used in the current UI but kept for legacy imports. |
| `passwordHash` | String | Required. Bcrypt hash of the password. |
| `role` | String | Defaults to `student`. Can also be `librarian` or `librarian_staff` when elevated. |
| `status` | String | One of `active`, `disabled`, `pending`. Default `active`. |
| `createdAt` / `updatedAt` | Date | Auto-managed timestamps. |

**Indexes**
- `{ studentId: 1 }` unique
- `{ email: 1 }` unique
- `{ barcode: 1 }` unique sparse

### `admins`
Stores librarian and librarian staff administrator accounts.

| Field | Type | Notes |
| --- | --- | --- |
| `_id` | ObjectId | Primary key. |
| `adminId` | String | Required. Unique. Follows the same hyphenated student ID pattern (`00-0000-00000` / `00-0000-000000`). |
| `email` | String | Optional. Unique + sparse. Stored lowercase. |
| `fullName` | String | Required. Trimmed. |
| `passwordHash` | String | Required. Bcrypt hash. |
| `role` | String | Enum `librarian` (highest) or `librarian_staff` (support role). Defaults to `librarian_staff`. |
| `status` | String | `active`, `disabled`, or `pending`. Default `active`. |
| `createdAt` / `updatedAt` | Date | Auto-managed timestamps. |

**Indexes**
- `{ adminId: 1 }` unique
- `{ email: 1 }` unique sparse

### `books`
Library catalog including cover and PDF metadata.

| Field | Type | Notes |
| --- | --- | --- |
| `_id` | ObjectId | Primary key. |
| `title` | String | Required. Trimmed. |
| `author` | String | Required. Trimmed. |
| `isbn` | String | Optional. Trimmed. |
| `bookCode` | String | Optional unique identifier for circulation. Unique + sparse. |
| `genre` | String | Optional category. |
| `tags` | [String] | Optional tag list. |
| `totalCopies` | Number | Total owned copies. Default 1. |
| `availableCopies` | Number | Currently available copies. Default 1. |
| `coverImagePath` | String | Relative path for uploaded cover image. |
| `coverImageOriginalName` | String | Original cover filename. |
| `coverImageFileId` | ObjectId | GridFS `_id` pointing to the stored cover in the `uploads` bucket. |
| `coverImageMime` | String | MIME type recorded for the cover image. |
| `pdfPath` | String | Relative path for uploaded PDF. |
| `pdfOriginalName` | String | Original PDF filename. |
| `pdfFileId` | ObjectId | GridFS `_id` pointing to the stored PDF in the `uploads` bucket. |
| `pdfMime` | String | MIME type recorded for the PDF (usually `application/pdf`). |
| `createdAt` / `updatedAt` | Date | Auto timestamps. |

**Indexes**
- Text index on `{ title: 'text', author: 'text' }`
- Unique sparse index on `{ bookCode: 1 }`

> **File storage:** Cover images and PDFs are streamed into MongoDB GridFS (bucket name `uploads`). The REST API exposes them at `GET /api/files/:id[/:name]`, so Compass will show the binary chunks under `uploads.files` / `uploads.chunks`. The `coverImagePath` / `pdfPath` fields simply store the public URL (e.g. `/api/files/<ObjectId>`) consumed by the frontend.

### `loans`
Tracks borrowing activity between students and books.

| Field | Type | Notes |
| --- | --- | --- |
| `_id` | ObjectId | Primary key. |
| `userId` | ObjectId | Required reference to a `users` document. |
| `bookId` | ObjectId | Required reference to a `books` document. |
| `borrowedAt` | Date | Defaults to now when created. |
| `dueAt` | Date | Required return due date. |
| `returnedAt` | Date | Null until the item is returned. |
| `createdAt` / `updatedAt` | Date | Auto timestamps. |

**Indexes**
- `{ userId: 1, returnedAt: 1 }`
- `{ bookId: 1, returnedAt: 1 }`
- `{ dueAt: 1 }`

### `visits`
Lobby tracker for student entry and exit logs.

| Field | Type | Notes |
| --- | --- | --- |
| `_id` | ObjectId | Primary key. |
| `userId` | ObjectId | Optional reference to a `users` document when matched. |
| `studentId` | String | Hyphenated identifier captured at the desk. |
| `barcode` | String | Optional legacy fallback. No longer populated by the UI. |
| `branch` | String | Library branch name. Default `Main`. |
| `enteredAt` | Date | Entry timestamp (default now). |
| `exitedAt` | Date | Exit timestamp. Null until exit recorded. |
| `createdAt` / `updatedAt` | Date | Auto timestamps. |

**Indexes**
- `{ studentId: 1, enteredAt: -1 }`
- `{ barcode: 1, enteredAt: -1 }`
- `{ userId: 1, enteredAt: -1 }`

### `hours`
Weekly opening hours per branch.

| Field | Type | Notes |
| --- | --- | --- |
| `_id` | ObjectId | Primary key. |
| `branch` | String | Required branch name. |
| `dayOfWeek` | Number | 0–6 (Sunday–Saturday). |
| `open` | String | Opening time (`HH:mm`). |
| `close` | String | Closing time (`HH:mm`). |
| `createdAt` / `updatedAt` | Date | Auto timestamps. |

**Indexes**
- Unique composite on `{ branch: 1, dayOfWeek: 1 }`

### `passwordresets`
Temporary password reset tokens for both students and admins.

| Field | Type | Notes |
| --- | --- | --- |
| `_id` | ObjectId | Primary key. |
| `userId` | ObjectId | Reference to the account requesting the reset. |
| `tokenHash` | String | SHA-256 hash of the emailed token. |
| `createdAt` | Date | Automatically set on create. |
| `expiresAt` | Date | Expiration timestamp. |
| `used` | Boolean | Default `false`. Marks completed resets. |
| `usedAt` | Date | Timestamp of successful reset, otherwise `null`. |

**Indexes**
- `{ userId: 1, expiresAt: 1, used: 1 }`

## Relationships Summary

- `admins` and `users` share the same login endpoint. Tokens include the `role` field so the frontend can redirect between the admin and student portals.
- `loans.bookId` references `books._id`; `loans.userId` references `users._id`.
- `visits.userId` references `users._id` when a matching student account is found during tracking.
- `passwordresets.userId` references either an admin or student account because IDs are globally unique across both collections.

## Seeding & Index Scripts

- `Backend/scripts/seed.js` populates sample admins, students, books, and hours for local development.
- `Backend/scripts/indexes.js` ensures the unique indexes above exist if you run it separately from the application.

Ensure your MongoDB Atlas/Compass cluster has these collections and indexes so the application can create, read, and update data without conflicts.
